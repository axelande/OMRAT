<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 950 750" font-family="Arial, sans-serif">
  <defs>
    <marker id="arr-m" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333"/>
    </marker>
    <marker id="arr-red" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#C62828"/>
    </marker>
    <marker id="arr-purple" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#6A1B9A"/>
    </marker>
  </defs>

  <text x="475" y="30" text-anchor="middle" font-size="20" font-weight="bold" fill="#1a1a2e">Monte Carlo Probability Integration</text>
  <text x="475" y="50" text-anchor="middle" font-size="12" fill="#666">Computing the probability that a drifting ship hits an obstacle</text>

  <!-- ============================================================ -->
  <!-- LEFT: The geometric setup -->
  <!-- ============================================================ -->
  <rect x="20" y="70" width="420" height="420" rx="8" fill="#F3E5F5" stroke="#9C27B0" stroke-width="2"/>
  <text x="230" y="95" text-anchor="middle" font-size="14" font-weight="bold" fill="#6A1B9A">Geometric Setup</text>

  <!-- Shipping leg (horizontal line at bottom) -->
  <line x1="60" y1="420" x2="380" y2="420" stroke="#333" stroke-width="3"/>
  <circle cx="60" cy="420" r="5" fill="#4CAF50"/>
  <circle cx="380" cy="420" r="5" fill="#F44336"/>
  <text x="220" y="445" text-anchor="middle" font-size="10" fill="#333" font-weight="bold">Shipping Leg (L metres)</text>

  <!-- Lateral distribution indicators -->
  <line x1="60" y1="380" x2="60" y2="460" stroke="#1565C0" stroke-width="1" stroke-dasharray="3"/>
  <line x1="380" y1="380" x2="380" y2="460" stroke="#1565C0" stroke-width="1" stroke-dasharray="3"/>

  <!-- Perpendicular width markers -->
  <line x1="55" y1="395" x2="55" y2="420" stroke="#1565C0" stroke-width="1.5"/>
  <line x1="55" y1="420" x2="55" y2="445" stroke="#1565C0" stroke-width="1.5"/>
  <text x="35" y="405" font-size="8" fill="#1565C0">+W/2</text>
  <text x="35" y="440" font-size="8" fill="#1565C0">-W/2</text>

  <!-- Corridor extent (rectangle going north) -->
  <rect x="50" y="130" width="340" height="310" fill="#E1BEE7" fill-opacity="0.15" stroke="#AB47BC" stroke-width="1.5" stroke-dasharray="5,3"/>
  <text x="395" y="285" font-size="9" fill="#AB47BC" transform="rotate(-90,395,285)">Corridor extent (d_max)</text>

  <!-- Obstacle (irregular blob in corridor) -->
  <ellipse cx="230" cy="230" rx="60" ry="35" fill="#F44336" fill-opacity="0.4" stroke="#C62828" stroke-width="2"/>
  <text x="230" y="235" text-anchor="middle" font-size="10" fill="#C62828" font-weight="bold">Obstacle</text>

  <!-- Sample rays - mix of hits and misses -->
  <!-- Hit rays (red) -->
  <line x1="150" y1="415" x2="150" y2="135" stroke="#C62828" stroke-width="1" opacity="0.6" marker-end="url(#arr-red)"/>
  <line x1="195" y1="415" x2="195" y2="135" stroke="#C62828" stroke-width="1" opacity="0.6" marker-end="url(#arr-red)"/>
  <line x1="220" y1="415" x2="220" y2="135" stroke="#C62828" stroke-width="1" opacity="0.6" marker-end="url(#arr-red)"/>
  <line x1="250" y1="415" x2="250" y2="135" stroke="#C62828" stroke-width="1" opacity="0.6" marker-end="url(#arr-red)"/>
  <line x1="280" y1="415" x2="280" y2="135" stroke="#C62828" stroke-width="1" opacity="0.6" marker-end="url(#arr-red)"/>

  <!-- Miss rays (purple) -->
  <line x1="85" y1="415" x2="85" y2="135" stroke="#6A1B9A" stroke-width="0.7" opacity="0.3" marker-end="url(#arr-purple)"/>
  <line x1="110" y1="415" x2="110" y2="135" stroke="#6A1B9A" stroke-width="0.7" opacity="0.3" marker-end="url(#arr-purple)"/>
  <line x1="320" y1="415" x2="320" y2="135" stroke="#6A1B9A" stroke-width="0.7" opacity="0.3" marker-end="url(#arr-purple)"/>
  <line x1="345" y1="415" x2="345" y2="135" stroke="#6A1B9A" stroke-width="0.7" opacity="0.3" marker-end="url(#arr-purple)"/>
  <line x1="365" y1="415" x2="365" y2="135" stroke="#6A1B9A" stroke-width="0.7" opacity="0.3" marker-end="url(#arr-purple)"/>

  <!-- Intersection points on obstacle -->
  <circle cx="150" cy="240" r="4" fill="#C62828"/>
  <circle cx="195" cy="220" r="4" fill="#C62828"/>
  <circle cx="220" cy="210" r="4" fill="#C62828"/>
  <circle cx="250" cy="215" r="4" fill="#C62828"/>
  <circle cx="280" cy="235" r="4" fill="#C62828"/>

  <!-- Sample start points on leg -->
  <circle cx="85" cy="420" r="3" fill="#6A1B9A" opacity="0.6"/>
  <circle cx="110" cy="420" r="3" fill="#6A1B9A" opacity="0.6"/>
  <circle cx="150" cy="420" r="3" fill="#C62828"/>
  <circle cx="195" cy="420" r="3" fill="#C62828"/>
  <circle cx="220" cy="420" r="3" fill="#C62828"/>
  <circle cx="250" cy="420" r="3" fill="#C62828"/>
  <circle cx="280" cy="420" r="3" fill="#C62828"/>
  <circle cx="320" cy="420" r="3" fill="#6A1B9A" opacity="0.6"/>
  <circle cx="345" cy="420" r="3" fill="#6A1B9A" opacity="0.6"/>
  <circle cx="365" cy="420" r="3" fill="#6A1B9A" opacity="0.6"/>

  <!-- Lateral distribution curve at bottom -->
  <g transform="translate(50, 458)">
    <path d="M 0,0 C 30,-2 60,-8 85,-20 C 110,-35 130,-55 170,-65 C 210,-55 230,-35 255,-20 C 280,-8 310,-2 340,0" fill="#E1BEE7" fill-opacity="0.3" stroke="#6A1B9A" stroke-width="1.5"/>
    <line x1="0" y1="0" x2="340" y2="0" stroke="#333" stroke-width="1"/>
    <text x="170" y="15" text-anchor="middle" font-size="9" fill="#333">f(y) = lateral traffic distribution</text>
    <!-- Arrow showing f(y) values -->
    <line x1="170" y1="-65" x2="190" y2="-65" stroke="#6A1B9A" stroke-width="1"/>
    <text x="215" y="-62" font-size="8" fill="#6A1B9A">f(y) high at centre</text>
    <line x1="40" y1="-5" x2="60" y2="-5" stroke="#6A1B9A" stroke-width="1"/>
    <text x="100" y="-2" font-size="8" fill="#6A1B9A">f(y) low at edges</text>
  </g>

  <!-- Legend -->
  <g transform="translate(60, 108)">
    <line x1="0" y1="0" x2="15" y2="0" stroke="#C62828" stroke-width="1.5"/>
    <circle cx="7" cy="0" r="3" fill="#C62828"/>
    <text x="20" y="4" font-size="9" fill="#333">Ray hits obstacle (contributes to P)</text>
    <line x1="180" y1="0" x2="195" y2="0" stroke="#6A1B9A" stroke-width="0.7" opacity="0.5"/>
    <circle cx="187" cy="0" r="3" fill="#6A1B9A" opacity="0.6"/>
    <text x="200" y="4" font-size="9" fill="#333">Ray misses (no contribution)</text>
  </g>

  <!-- ============================================================ -->
  <!-- RIGHT: Algorithm Steps -->
  <!-- ============================================================ -->
  <rect x="460" y="70" width="470" height="420" rx="8" fill="#E8F5E9" stroke="#4CAF50" stroke-width="2"/>
  <text x="695" y="95" text-anchor="middle" font-size="14" font-weight="bold" fill="#2E7D32">Algorithm Steps</text>

  <!-- Step 1 -->
  <rect x="480" y="108" width="430" height="55" rx="5" fill="white" fill-opacity="0.7" stroke="#81C784" stroke-width="1"/>
  <text x="495" y="125" font-size="11" fill="#2E7D32" font-weight="bold">1. Generate N random samples</text>
  <text x="495" y="142" font-size="9" fill="#333">s_k ~ Uniform(0, 1)  :  position along leg</text>
  <text x="495" y="156" font-size="9" fill="#333">y_k ~ Uniform(-W/2, +W/2)  :  lateral offset from centreline</text>

  <!-- Step 2 -->
  <rect x="480" y="170" width="430" height="55" rx="5" fill="white" fill-opacity="0.7" stroke="#81C784" stroke-width="1"/>
  <text x="495" y="187" font-size="11" fill="#2E7D32" font-weight="bold">2. Compute start position for each sample</text>
  <text x="495" y="204" font-size="9" fill="#333">p_start = leg_start + s_k * leg_vec + y_k * perp_dir</text>
  <text x="495" y="218" font-size="9" fill="#666">(vectorised: all N positions computed at once with numpy)</text>

  <!-- Step 3 -->
  <rect x="480" y="232" width="430" height="55" rx="5" fill="white" fill-opacity="0.7" stroke="#81C784" stroke-width="1"/>
  <text x="495" y="249" font-size="11" fill="#2E7D32" font-weight="bold">3. Cast ray in drift direction</text>
  <text x="495" y="266" font-size="9" fill="#333">p_end = p_start + d_max * drift_unit_vector</text>
  <text x="495" y="280" font-size="9" fill="#666">(all N endpoints computed simultaneously)</text>

  <!-- Step 4 -->
  <rect x="480" y="294" width="430" height="70" rx="5" fill="white" fill-opacity="0.7" stroke="#81C784" stroke-width="1"/>
  <text x="495" y="311" font-size="11" fill="#2E7D32" font-weight="bold">4. Test ray-polygon intersection</text>
  <text x="495" y="328" font-size="9" fill="#333">For each ray, test against all edges of obstacle polygon</text>
  <text x="495" y="342" font-size="9" fill="#333">Uses parametric intersection: solve for t, s in [0,1]</text>
  <text x="495" y="356" font-size="9" fill="#666">(vectorised cross-product computation, bbox pre-filter)</text>

  <!-- Step 5 -->
  <rect x="480" y="371" width="430" height="55" rx="5" fill="white" fill-opacity="0.7" stroke="#81C784" stroke-width="1"/>
  <text x="495" y="388" font-size="11" fill="#2E7D32" font-weight="bold">5. Weight hits by lateral PDF f(y)</text>
  <text x="495" y="405" font-size="9" fill="#333">For each hit k:  weight_k = Sum_i( w_i * Normal(y_k; mu_i, sigma_i) )</text>
  <text x="495" y="419" font-size="9" fill="#666">(mixture of up to 3 normals + 1 uniform distribution)</text>

  <!-- Step 6 (result) -->
  <rect x="480" y="433" width="430" height="45" rx="5" fill="#C8E6C9" fill-opacity="0.7" stroke="#2E7D32" stroke-width="1.5"/>
  <text x="495" y="452" font-size="11" fill="#2E7D32" font-weight="bold">6. Estimate probability</text>
  <text x="495" y="469" font-size="10" fill="#1B5E20" font-weight="bold">P = (W / N) * Sum_hits( f(y_k) ) / leg_length</text>

  <!-- ============================================================ -->
  <!-- BOTTOM: Performance and Multi-Obstacle -->
  <!-- ============================================================ -->
  <rect x="20" y="510" width="450" height="220" rx="8" fill="#FFF3E0" stroke="#FF9800" stroke-width="2"/>
  <text x="245" y="535" text-anchor="middle" font-size="14" font-weight="bold" fill="#E65100">Performance Optimisations</text>

  <text x="40" y="560" font-size="10" fill="#333" font-weight="bold">Vectorised ray testing (numpy)</text>
  <text x="40" y="578" font-size="9" fill="#333">All N rays tested against all E edges in batch operations.</text>
  <text x="40" y="593" font-size="9" fill="#333">~3x faster than per-ray Shapely intersection calls.</text>

  <text x="40" y="618" font-size="10" fill="#333" font-weight="bold">Bounding box pre-filter</text>
  <text x="40" y="636" font-size="9" fill="#333">Skip obstacle rings whose bbox doesn't overlap the ray bbox.</text>

  <text x="40" y="660" font-size="10" fill="#333" font-weight="bold">Adaptive sample count</text>
  <text x="40" y="678" font-size="9" fill="#333">cumulative P &gt; 0.95 --> reduce to 200 samples (from 500)</text>
  <text x="40" y="693" font-size="9" fill="#333">cumulative P &gt; 0.80 --> reduce to 300 samples</text>

  <text x="40" y="718" font-size="10" fill="#333" font-weight="bold">Parallel execution</text>
  <text x="40" y="733" font-size="9" fill="#333">ThreadPoolExecutor: one task per (leg, direction) pair</text>

  <!-- Multi-obstacle cascade -->
  <rect x="490" y="510" width="440" height="220" rx="8" fill="#E3F2FD" stroke="#1976D2" stroke-width="2"/>
  <text x="710" y="535" text-anchor="middle" font-size="14" font-weight="bold" fill="#0D47A1">Multi-Obstacle Processing</text>

  <!-- Obstacle ordering diagram -->
  <g transform="translate(510, 545)">
    <!-- Leg -->
    <line x1="0" y1="150" x2="200" y2="150" stroke="#333" stroke-width="2"/>
    <text x="100" y="170" text-anchor="middle" font-size="8" fill="#333">Leg</text>

    <!-- Obstacle 1 (closest) -->
    <ellipse cx="100" cy="110" rx="30" ry="12" fill="#F44336" fill-opacity="0.5" stroke="#C62828" stroke-width="1.5"/>
    <text x="100" y="114" text-anchor="middle" font-size="7" fill="#C62828">Obs 1 (near)</text>

    <!-- Shadow from obs 1 -->
    <rect x="68" y="60" width="64" height="50" fill="#FFCDD2" fill-opacity="0.2" stroke="#E57373" stroke-width="0.5" stroke-dasharray="2"/>

    <!-- Obstacle 2 (farther, partially blocked) -->
    <ellipse cx="100" cy="40" rx="40" ry="15" fill="#1976D2" fill-opacity="0.3" stroke="#1565C0" stroke-width="1.5"/>
    <text x="100" y="44" text-anchor="middle" font-size="7" fill="#0D47A1">Obs 2 (far)</text>

    <!-- Drift arrow -->
    <line x1="210" y1="145" x2="210" y2="50" stroke="#2E7D32" stroke-width="1.5" marker-end="url(#arr-m)"/>
    <text x="225" y="100" font-size="8" fill="#2E7D32">Drift</text>
  </g>

  <g transform="translate(730, 555)">
    <text x="0" y="0" font-size="10" fill="#333" font-weight="bold">Processing order:</text>
    <text x="0" y="18" font-size="9" fill="#333">1. Sort obstacles by distance</text>
    <text x="0" y="33" font-size="9" fill="#333">   from leg (nearest first)</text>
    <text x="0" y="55" font-size="9" fill="#333">2. Compute P for obstacle 1</text>
    <text x="0" y="70" font-size="9" fill="#333">3. Reduce corridor by shadow_1</text>
    <text x="0" y="85" font-size="9" fill="#333">4. Compute P for obstacle 2</text>
    <text x="0" y="100" font-size="9" fill="#333">   (using reduced corridor)</text>
    <text x="0" y="122" font-size="9" fill="#0D47A1" font-weight="bold">Cascading shadows prevent</text>
    <text x="0" y="137" font-size="9" fill="#0D47A1" font-weight="bold">double-counting probability</text>
    <text x="0" y="160" font-size="9" fill="#333">Early termination when</text>
    <text x="0" y="175" font-size="9" fill="#333">cumulative P >= 0.99</text>
  </g>
</svg>
