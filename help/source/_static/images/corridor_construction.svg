<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1100" font-family="Arial, sans-serif">
  <defs>
    <marker id="arr-c" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333"/>
    </marker>
    <marker id="arr-blue" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#1565C0"/>
    </marker>
    <marker id="arr-green" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#2E7D32"/>
    </marker>
    <pattern id="hatch" patternUnits="userSpaceOnUse" width="8" height="8" patternTransform="rotate(45)">
      <line x1="0" y1="0" x2="0" y2="8" stroke="#E57373" stroke-width="2"/>
    </pattern>
  </defs>

  <text x="500" y="30" text-anchor="middle" font-size="20" font-weight="bold" fill="#1a1a2e">Drift Corridor Construction: Step-by-Step Example</text>
  <text x="500" y="50" text-anchor="middle" font-size="12" fill="#666">Ship drifting North (0°) from a horizontal shipping leg</text>

  <!-- ============================================================ -->
  <!-- STEP 1: Base Surface -->
  <!-- ============================================================ -->
  <rect x="20" y="65" width="460" height="230" rx="8" fill="#e3f2fd" stroke="#1976D2" stroke-width="2"/>
  <text x="250" y="90" text-anchor="middle" font-size="15" font-weight="bold" fill="#0D47A1">Step 1: Create Base Surface</text>

  <!-- Shipping leg (horizontal) -->
  <line x1="80" y1="180" x2="310" y2="180" stroke="#333" stroke-width="3"/>
  <circle cx="80" cy="180" r="5" fill="#4CAF50"/>
  <circle cx="310" cy="180" r="5" fill="#F44336"/>
  <text x="195" y="175" text-anchor="middle" font-size="10" fill="#333" font-weight="bold">Shipping Leg</text>

  <!-- Perpendicular arrows showing half-width -->
  <line x1="195" y1="140" x2="195" y2="180" stroke="#1565C0" stroke-width="1.5" stroke-dasharray="4" marker-start="url(#arr-blue)"/>
  <line x1="195" y1="220" x2="195" y2="180" stroke="#1565C0" stroke-width="1.5" stroke-dasharray="4" marker-start="url(#arr-blue)"/>
  <text x="210" y="155" font-size="9" fill="#1565C0">half_width</text>
  <text x="210" y="215" font-size="9" fill="#1565C0">half_width</text>

  <!-- Base surface rectangle -->
  <rect x="80" y="140" width="230" height="80" fill="#BBDEFB" fill-opacity="0.35" stroke="#64B5F6" stroke-width="2" stroke-dasharray="6,3"/>

  <!-- Corner labels -->
  <text x="70" y="137" font-size="8" fill="#0D47A1">B1</text>
  <text x="70" y="228" font-size="8" fill="#0D47A1">B4</text>
  <text x="312" y="137" font-size="8" fill="#0D47A1">B2</text>
  <text x="312" y="228" font-size="8" fill="#0D47A1">B3</text>

  <!-- Formula -->
  <text x="250" y="258" text-anchor="middle" font-size="10" fill="#333">width = 2 x Z(0.995) x sigma_lateral</text>
  <text x="250" y="273" text-anchor="middle" font-size="10" fill="#333">Covers 99% of the lateral traffic distribution</text>
  <text x="250" y="288" text-anchor="middle" font-size="9" fill="#666">Implementation: corridor.py:create_base_surface()</text>

  <!-- Lateral distribution curve on the right -->
  <g transform="translate(380,120)">
    <text x="40" y="5" text-anchor="middle" font-size="9" fill="#333" font-weight="bold">Lateral PDF</text>
    <!-- Bell curve -->
    <path d="M 0,120 C 10,118 15,110 20,90 C 25,65 30,30 40,15 C 45,30 50,65 55,90 C 60,110 65,118 80,120" fill="none" stroke="#1565C0" stroke-width="2"/>
    <!-- Axis -->
    <line x1="0" y1="120" x2="80" y2="120" stroke="#333" stroke-width="1"/>
    <!-- 99% markers -->
    <line x1="8" y1="115" x2="8" y2="125" stroke="#E91E63" stroke-width="1.5"/>
    <line x1="72" y1="115" x2="72" y2="125" stroke="#E91E63" stroke-width="1.5"/>
    <text x="40" y="135" text-anchor="middle" font-size="8" fill="#E91E63">99% coverage</text>
    <!-- Shaded area -->
    <path d="M 8,120 C 13,118 15,110 20,90 C 25,65 30,30 40,15 C 45,30 50,65 55,90 C 60,110 63,118 72,120 Z" fill="#E91E63" fill-opacity="0.15"/>
  </g>

  <!-- Arrow to step 2 -->
  <line x1="480" y1="180" x2="520" y2="180" stroke="#333" stroke-width="2" marker-end="url(#arr-c)"/>

  <!-- ============================================================ -->
  <!-- STEP 2: Project Along Drift Direction -->
  <!-- ============================================================ -->
  <rect x="520" y="65" width="460" height="230" rx="8" fill="#e8f5e9" stroke="#4CAF50" stroke-width="2"/>
  <text x="750" y="90" text-anchor="middle" font-size="15" font-weight="bold" fill="#2E7D32">Step 2: Project in Drift Direction</text>

  <!-- Base surface (bottom) -->
  <rect x="620" y="200" width="140" height="50" fill="#BBDEFB" fill-opacity="0.35" stroke="#64B5F6" stroke-width="1.5"/>
  <text x="690" y="230" text-anchor="middle" font-size="9" fill="#0D47A1">Base surface</text>

  <!-- Drift direction arrow (North = upward) -->
  <line x1="690" y1="195" x2="690" y2="140" stroke="#2E7D32" stroke-width="2.5" marker-end="url(#arr-green)"/>
  <text x="710" y="165" font-size="10" fill="#2E7D32" font-weight="bold">Drift N</text>

  <!-- Projected surface (top) -->
  <rect x="620" y="100" width="140" height="50" fill="#C8E6C9" fill-opacity="0.35" stroke="#81C784" stroke-width="1.5" stroke-dasharray="5,3"/>
  <text x="690" y="130" text-anchor="middle" font-size="9" fill="#2E7D32">Projected copy</text>

  <!-- Combined corridor (convex hull outline) -->
  <polygon points="620,250 620,100 760,100 760,250" fill="#E8F5E9" fill-opacity="0.15" stroke="#4CAF50" stroke-width="2" stroke-dasharray="3"/>

  <!-- Projection distance label -->
  <line x1="780" y1="250" x2="780" y2="100" stroke="#2E7D32" stroke-width="1" stroke-dasharray="3"/>
  <text x="795" y="175" font-size="9" fill="#2E7D32" transform="rotate(-90,795,175)">d_max (projection dist)</text>

  <!-- Vector formula -->
  <text x="750" y="268" text-anchor="middle" font-size="10" fill="#333">v_drift = d_max x (cos(theta), sin(theta))</text>
  <text x="750" y="283" text-anchor="middle" font-size="10" fill="#333">Corridor = convex_hull(base + projected)</text>
  <text x="750" y="298" text-anchor="middle" font-size="9" fill="#666">theta_math = 90° + theta_compass</text>

  <!-- ============================================================ -->
  <!-- STEP 3: Obstacle Shadow (Quad-Sweep) -->
  <!-- ============================================================ -->
  <rect x="20" y="315" width="460" height="280" rx="8" fill="#fff3e0" stroke="#FF9800" stroke-width="2"/>
  <text x="250" y="340" text-anchor="middle" font-size="15" font-weight="bold" fill="#E65100">Step 3: Create Obstacle Shadows</text>

  <!-- Obstacle (irregular shape) -->
  <polygon points="130,400 170,385 210,395 220,430 200,455 150,450 125,430" fill="#F44336" fill-opacity="0.7" stroke="#C62828" stroke-width="2"/>
  <text x="170" y="425" text-anchor="middle" font-size="9" fill="white" font-weight="bold">Obstacle</text>

  <!-- Translated copy (far, same shape) -->
  <polygon points="130,490 170,475 210,485 220,520 200,545 150,540 125,520" fill="#F44336" fill-opacity="0.2" stroke="#C62828" stroke-width="1" stroke-dasharray="4"/>
  <text x="170" y="515" text-anchor="middle" font-size="8" fill="#C62828">Translated copy</text>

  <!-- Quad edges connecting original to translated -->
  <polygon points="130,400 170,385 170,475 130,490" fill="#FFCDD2" fill-opacity="0.3" stroke="#E57373" stroke-width="1"/>
  <polygon points="170,385 210,395 210,485 170,475" fill="#FFCDD2" fill-opacity="0.3" stroke="#E57373" stroke-width="1"/>
  <polygon points="210,395 220,430 220,520 210,485" fill="#FFCDD2" fill-opacity="0.3" stroke="#E57373" stroke-width="1"/>
  <polygon points="220,430 200,455 200,545 220,520" fill="#FFCDD2" fill-opacity="0.3" stroke="#E57373" stroke-width="1"/>
  <polygon points="200,455 150,450 150,540 200,545" fill="#FFCDD2" fill-opacity="0.3" stroke="#E57373" stroke-width="1"/>
  <polygon points="150,450 125,430 125,520 150,540" fill="#FFCDD2" fill-opacity="0.3" stroke="#E57373" stroke-width="1"/>
  <polygon points="125,430 130,400 130,490 125,520" fill="#FFCDD2" fill-opacity="0.3" stroke="#E57373" stroke-width="1"/>

  <!-- Drift direction -->
  <line x1="80" y1="395" x2="80" y2="465" stroke="#FF9800" stroke-width="2" marker-end="url(#arr-c)"/>
  <text x="60" y="435" font-size="10" fill="#E65100" font-weight="bold">Drift</text>

  <!-- Labels for quads -->
  <text x="300" y="370" font-size="10" fill="#333" font-weight="bold">Quad-sweep algorithm:</text>
  <text x="300" y="388" font-size="9" fill="#333">1. Translate obstacle along drift vector</text>
  <text x="300" y="404" font-size="9" fill="#333">2. Connect each edge pair with a quad</text>
  <text x="300" y="420" font-size="9" fill="#333">3. Union: original + quads + translated</text>
  <text x="300" y="444" font-size="10" fill="#E65100" font-weight="bold">Why quads (not convex hull)?</text>
  <text x="300" y="460" font-size="9" fill="#333">Convex hull fills concave gaps,</text>
  <text x="300" y="476" font-size="9" fill="#333">blocking areas ships CAN drift through.</text>
  <text x="300" y="492" font-size="9" fill="#333">Quads preserve exact contour shape.</text>

  <!-- Mini comparison: convex hull vs quads -->
  <g transform="translate(300,505)">
    <!-- Concave obstacle -->
    <text x="0" y="10" font-size="8" fill="#C62828" font-weight="bold">Concave obstacle:</text>
    <polygon points="10,20 40,20 40,40 30,40 30,30 10,30" fill="#F44336" fill-opacity="0.5" stroke="#C62828" stroke-width="1"/>
    <!-- Convex hull (wrong) -->
    <text x="60" y="10" font-size="8" fill="#C62828">Convex hull (gap filled!)</text>
    <polygon points="60,20 90,20 90,50 60,50" fill="#FFCDD2" fill-opacity="0.5" stroke="#C62828" stroke-width="1"/>
    <text x="75" y="65" font-size="7" fill="#C62828">Ships blocked incorrectly</text>
    <!-- Quads (correct) -->
    <text x="120" y="10" font-size="8" fill="#2E7D32">Quads (gap preserved!)</text>
    <polygon points="120,20 150,20 150,50 120,50" fill="#C8E6C9" fill-opacity="0.5" stroke="#2E7D32" stroke-width="1"/>
    <rect x="130" y="30" width="10" height="10" fill="white" stroke="#2E7D32" stroke-width="1"/>
    <text x="150" y="65" font-size="7" fill="#2E7D32">Ships can drift through gap</text>
  </g>

  <!-- Arrow down to step 4 -->
  <line x1="250" y1="595" x2="250" y2="625" stroke="#333" stroke-width="2" marker-end="url(#arr-c)"/>

  <!-- ============================================================ -->
  <!-- STEP 4: Clip Corridor -->
  <!-- ============================================================ -->
  <rect x="520" y="315" width="460" height="280" rx="8" fill="#fce4ec" stroke="#E91E63" stroke-width="2"/>
  <text x="750" y="340" text-anchor="middle" font-size="15" font-weight="bold" fill="#AD1457">Step 4: Clip Corridor at Obstacles</text>

  <!-- Original corridor (tall rectangle going north) -->
  <rect x="620" y="360" width="120" height="200" fill="#E8F5E9" fill-opacity="0.3" stroke="#4CAF50" stroke-width="1.5"/>
  <text x="680" y="555" text-anchor="middle" font-size="8" fill="#4CAF50">Full corridor</text>

  <!-- Obstacle inside corridor -->
  <polygon points="640,430 680,420 710,435 720,460 700,475 650,470 635,455" fill="#F44336" fill-opacity="0.6" stroke="#C62828" stroke-width="1.5"/>
  <text x="680" y="450" text-anchor="middle" font-size="8" fill="white" font-weight="bold">Obs</text>

  <!-- Shadow zone (hatched area below obstacle) -->
  <rect x="630" y="460" width="100" height="100" fill="url(#hatch)" fill-opacity="0.3" stroke="#E57373" stroke-width="1" stroke-dasharray="3"/>
  <text x="680" y="520" text-anchor="middle" font-size="8" fill="#C62828">Shadow</text>
  <text x="680" y="533" text-anchor="middle" font-size="8" fill="#C62828">(removed)</text>

  <!-- Arrow showing result -->
  <line x1="760" y1="460" x2="810" y2="460" stroke="#333" stroke-width="2" marker-end="url(#arr-c)"/>
  <text x="785" y="452" font-size="8" fill="#333">Result</text>

  <!-- Result: corridor with hole -->
  <rect x="820" y="360" width="80" height="70" fill="#C8E6C9" fill-opacity="0.5" stroke="#388E3C" stroke-width="1.5"/>
  <text x="860" y="400" text-anchor="middle" font-size="8" fill="#2E7D32">Reachable</text>

  <!-- Upwind edge indicator -->
  <line x1="620" y1="558" x2="740" y2="558" stroke="#1565C0" stroke-width="3"/>
  <text x="680" y="575" text-anchor="middle" font-size="8" fill="#1565C0" font-weight="bold">Upwind edge (ships start here)</text>

  <!-- Drift direction -->
  <line x1="580" y1="500" x2="580" y2="410" stroke="#FF9800" stroke-width="2" marker-end="url(#arr-c)"/>
  <text x="563" y="455" font-size="10" fill="#E65100" font-weight="bold" transform="rotate(-90,563,455)">Drift N</text>

  <!-- Key formula -->
  <text x="860" y="465" text-anchor="middle" font-size="9" fill="#333">Corridor_clipped =</text>
  <text x="860" y="480" text-anchor="middle" font-size="9" fill="#333">Corridor - Union(shadows)</text>
  <text x="860" y="500" text-anchor="middle" font-size="9" fill="#AD1457">Only parts reachable</text>
  <text x="860" y="515" text-anchor="middle" font-size="9" fill="#AD1457">from upwind edge</text>
  <text x="860" y="530" text-anchor="middle" font-size="9" fill="#AD1457">are kept.</text>

  <!-- ============================================================ -->
  <!-- STEP 5: Anchor Zone Split -->
  <!-- ============================================================ -->
  <rect x="20" y="635" width="460" height="220" rx="8" fill="#e0f2f1" stroke="#009688" stroke-width="2"/>
  <text x="250" y="660" text-anchor="middle" font-size="15" font-weight="bold" fill="#00695C">Step 5: Anchor Zone Split</text>

  <!-- Clipped corridor -->
  <rect x="60" y="680" width="180" height="130" fill="#E0E0E0" fill-opacity="0.3" stroke="#9E9E9E" stroke-width="1"/>

  <!-- Shallow zone (anchorable) -->
  <rect x="60" y="750" width="180" height="60" fill="#42A5F5" fill-opacity="0.35" stroke="#1E88E5" stroke-width="1.5"/>
  <text x="150" y="775" text-anchor="middle" font-size="9" fill="#0D47A1" font-weight="bold">Anchorable (blue)</text>
  <text x="150" y="790" text-anchor="middle" font-size="8" fill="#0D47A1">depth &lt; anchor_max</text>

  <!-- Deep zone -->
  <rect x="60" y="680" width="180" height="70" fill="#66BB6A" fill-opacity="0.35" stroke="#43A047" stroke-width="1.5"/>
  <text x="150" y="712" text-anchor="middle" font-size="9" fill="#1B5E20" font-weight="bold">Deep water (green)</text>
  <text x="150" y="727" text-anchor="middle" font-size="8" fill="#1B5E20">depth >= anchor_max</text>

  <!-- Drift arrow -->
  <line x1="40" y1="790" x2="40" y2="700" stroke="#FF9800" stroke-width="2" marker-end="url(#arr-c)"/>
  <text x="27" y="745" font-size="9" fill="#E65100" font-weight="bold" transform="rotate(-90,27,745)">Drift N</text>

  <!-- Explanation -->
  <text x="280" y="695" font-size="10" fill="#333" font-weight="bold">Shadow extension rule:</text>
  <text x="280" y="715" font-size="9" fill="#333">Ships drifting through shallow</text>
  <text x="280" y="730" font-size="9" fill="#333">water can anchor there. Areas</text>
  <text x="280" y="745" font-size="9" fill="#333">BEHIND (downwind of) an anchor</text>
  <text x="280" y="760" font-size="9" fill="#333">zone are also safe, because the</text>
  <text x="280" y="775" font-size="9" fill="#333">ship passed through anchorable</text>
  <text x="280" y="790" font-size="9" fill="#333">water first.</text>

  <text x="280" y="815" font-size="9" fill="#00695C" font-weight="bold">Green behind blue --> reclassified blue</text>
  <text x="280" y="835" font-size="9" fill="#666">Implementation: clipping.py:split_corridor_by_anchor_zone()</text>

  <!-- ============================================================ -->
  <!-- STEP 6: Probability Integration -->
  <!-- ============================================================ -->
  <rect x="520" y="635" width="460" height="220" rx="8" fill="#f3e5f5" stroke="#9C27B0" stroke-width="2"/>
  <text x="750" y="660" text-anchor="middle" font-size="15" font-weight="bold" fill="#6A1B9A">Step 6: Monte Carlo Integration</text>

  <!-- Corridor with sample points -->
  <rect x="560" y="680" width="120" height="140" fill="#E1BEE7" fill-opacity="0.25" stroke="#AB47BC" stroke-width="1.5"/>
  <!-- Leg at bottom -->
  <line x1="560" y1="815" x2="680" y2="815" stroke="#333" stroke-width="2"/>
  <text x="620" y="830" text-anchor="middle" font-size="8" fill="#333">Leg</text>

  <!-- Obstacle in corridor -->
  <ellipse cx="620" cy="720" rx="35" ry="20" fill="#F44336" fill-opacity="0.4" stroke="#C62828" stroke-width="1.5"/>
  <text x="620" y="724" text-anchor="middle" font-size="7" fill="#C62828">Obstacle</text>

  <!-- Sample rays (some hitting, some missing) -->
  <line x1="580" y1="810" x2="580" y2="685" stroke="#7B1FA2" stroke-width="0.7" opacity="0.4"/>
  <line x1="600" y1="810" x2="600" y2="685" stroke="#F44336" stroke-width="1.2" opacity="0.7"/>
  <line x1="610" y1="810" x2="610" y2="685" stroke="#F44336" stroke-width="1.2" opacity="0.7"/>
  <line x1="625" y1="810" x2="625" y2="685" stroke="#F44336" stroke-width="1.2" opacity="0.7"/>
  <line x1="640" y1="810" x2="640" y2="685" stroke="#F44336" stroke-width="1.2" opacity="0.7"/>
  <line x1="655" y1="810" x2="655" y2="685" stroke="#7B1FA2" stroke-width="0.7" opacity="0.4"/>
  <line x1="670" y1="810" x2="670" y2="685" stroke="#7B1FA2" stroke-width="0.7" opacity="0.4"/>

  <!-- Sample points on leg -->
  <circle cx="580" cy="810" r="3" fill="#7B1FA2"/>
  <circle cx="600" cy="810" r="3" fill="#F44336"/>
  <circle cx="610" cy="810" r="3" fill="#F44336"/>
  <circle cx="625" cy="810" r="3" fill="#F44336"/>
  <circle cx="640" cy="810" r="3" fill="#F44336"/>
  <circle cx="655" cy="810" r="3" fill="#7B1FA2"/>
  <circle cx="670" cy="810" r="3" fill="#7B1FA2"/>

  <!-- Legend -->
  <circle cx="570" cy="845" r="3" fill="#F44336"/>
  <text x="580" y="848" font-size="8" fill="#333">= ray hits obstacle</text>
  <circle cx="650" cy="845" r="3" fill="#7B1FA2"/>
  <text x="660" y="848" font-size="8" fill="#333">= ray misses</text>

  <!-- Formula box -->
  <rect x="700" y="680" width="260" height="145" rx="5" fill="white" fill-opacity="0.6" stroke="#9C27B0" stroke-width="1"/>
  <text x="830" y="700" text-anchor="middle" font-size="10" fill="#6A1B9A" font-weight="bold">For each sample (s, y):</text>
  <text x="830" y="718" text-anchor="middle" font-size="9" fill="#333">1. Random position on leg</text>
  <text x="830" y="733" text-anchor="middle" font-size="9" fill="#333">2. Cast ray in drift direction</text>
  <text x="830" y="748" text-anchor="middle" font-size="9" fill="#333">3. Test ray-polygon intersection</text>
  <text x="830" y="763" text-anchor="middle" font-size="9" fill="#333">4. If hit: weight by f(y) = PDF</text>
  <text x="830" y="785" text-anchor="middle" font-size="10" fill="#6A1B9A" font-weight="bold">P = (W/N) * Sum(f(y_hit))</text>
  <text x="830" y="803" text-anchor="middle" font-size="9" fill="#666">Vectorised numpy ray tests</text>
  <text x="830" y="818" text-anchor="middle" font-size="9" fill="#666">~3x faster than Shapely</text>

  <!-- ============================================================ -->
  <!-- FINAL: 8-Direction Combination -->
  <!-- ============================================================ -->
  <rect x="20" y="880" width="960" height="200" rx="8" fill="#ECEFF1" stroke="#78909C" stroke-width="2"/>
  <text x="500" y="905" text-anchor="middle" font-size="15" font-weight="bold" fill="#37474F">Steps 1-6 Repeated for All 8 Wind Directions</text>

  <!-- Wind rose (mini) -->
  <g transform="translate(120,990)">
    <line x1="0" y1="-50" x2="0" y2="50" stroke="#999" stroke-width="1"/>
    <line x1="-50" y1="0" x2="50" y2="0" stroke="#999" stroke-width="1"/>
    <line x1="-35" y1="-35" x2="35" y2="35" stroke="#999" stroke-width="0.5"/>
    <line x1="35" y1="-35" x2="-35" y2="35" stroke="#999" stroke-width="0.5"/>
    <!-- Direction labels -->
    <text x="0" y="-55" text-anchor="middle" font-size="9" fill="#e41a1c" font-weight="bold">N 0°</text>
    <text x="0" y="65" text-anchor="middle" font-size="9" fill="#ff7f00" font-weight="bold">S 180°</text>
    <text x="-58" y="4" text-anchor="middle" font-size="9" fill="#a65628" font-weight="bold">W 90°</text>
    <text x="58" y="4" text-anchor="middle" font-size="9" fill="#4daf4a" font-weight="bold">E 270°</text>
    <text x="-42" y="-42" text-anchor="middle" font-size="8" fill="#f781bf">NW 45°</text>
    <text x="42" y="-42" text-anchor="middle" font-size="8" fill="#377eb8">NE 315°</text>
    <text x="-42" y="50" text-anchor="middle" font-size="8" fill="#ffff33">SW 135°</text>
    <text x="42" y="50" text-anchor="middle" font-size="8" fill="#984ea3">SE 225°</text>
    <circle cx="0" cy="0" r="3" fill="#333"/>
  </g>

  <!-- Final risk formula -->
  <rect x="230" y="930" width="520" height="130" rx="5" fill="white" fill-opacity="0.7" stroke="#78909C" stroke-width="1"/>
  <text x="490" y="955" text-anchor="middle" font-size="12" fill="#37474F" font-weight="bold">Final Drifting Risk for Obstacle j from Leg i:</text>
  <text x="490" y="980" text-anchor="middle" font-size="11" fill="#333">R_ij = Sum_d [ W_d  x  P_hit(i,j,d)  x  P_blackout(i)  x  (1 - P_repair(i,j,d))  x  (1 - P_anchor(i,j,d)) ]  x  Sum_k Q_ik</text>
  <text x="490" y="1005" text-anchor="middle" font-size="9" fill="#666">W_d = wind rose weight  |  P_hit = Monte Carlo probability  |  P_blackout = Poisson blackout prob</text>
  <text x="490" y="1020" text-anchor="middle" font-size="9" fill="#666">P_repair = lognormal repair CDF  |  P_anchor = anchoring success prob  |  Q_ik = traffic frequency</text>
  <text x="490" y="1045" text-anchor="middle" font-size="10" fill="#37474F" font-weight="bold">Repeated for all legs and all obstacles, parallelised across (leg, direction) pairs</text>

  <!-- Total complexity -->
  <rect x="770" y="930" width="190" height="130" rx="5" fill="#FFF3E0" stroke="#FF9800" stroke-width="1"/>
  <text x="865" y="955" text-anchor="middle" font-size="10" fill="#E65100" font-weight="bold">Computation Scale</text>
  <text x="865" y="975" text-anchor="middle" font-size="9" fill="#333">L legs x 8 dirs x M obs</text>
  <text x="865" y="993" text-anchor="middle" font-size="9" fill="#333">x N samples each</text>
  <text x="865" y="015" text-anchor="middle" font-size="9" fill="#333">Example: 10 legs,</text>
  <text x="865" y="1030" text-anchor="middle" font-size="9" fill="#333">50 obstacles, 500 samples</text>
  <text x="865" y="1048" text-anchor="middle" font-size="9" fill="#E65100" font-weight="bold">= 2,000,000 ray tests</text>
</svg>
