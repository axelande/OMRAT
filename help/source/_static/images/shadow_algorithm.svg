<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 700" font-family="Arial, sans-serif">
  <defs>
    <marker id="arr-s" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333"/>
    </marker>
    <pattern id="diag" patternUnits="userSpaceOnUse" width="6" height="6" patternTransform="rotate(45)">
      <line x1="0" y1="0" x2="0" y2="6" stroke="#E57373" stroke-width="1.5"/>
    </pattern>
  </defs>

  <text x="450" y="30" text-anchor="middle" font-size="20" font-weight="bold" fill="#1a1a2e">Quad-Sweep Shadow Algorithm</text>
  <text x="450" y="50" text-anchor="middle" font-size="12" fill="#666">How OMRAT creates blocking zones behind obstacles (drift direction: North)</text>

  <!-- ============================================================ -->
  <!-- LEFT: The Algorithm Steps -->
  <!-- ============================================================ -->

  <!-- Step A: Original Obstacle -->
  <rect x="20" y="70" width="250" height="250" rx="6" fill="#FFF8E1" stroke="#FFC107" stroke-width="1.5"/>
  <text x="145" y="92" text-anchor="middle" font-size="13" font-weight="bold" fill="#F57F17">A. Original Obstacle</text>

  <!-- Concave L-shaped obstacle with labeled vertices -->
  <polygon points="60,140 140,120 180,140 190,180 170,220 140,230 100,220 80,200 60,190" fill="#F44336" fill-opacity="0.6" stroke="#C62828" stroke-width="2"/>
  <!-- Vertex labels -->
  <circle cx="60" cy="140" r="4" fill="#C62828"/>
  <text x="48" y="138" font-size="9" fill="#C62828" font-weight="bold">v0</text>
  <circle cx="140" cy="120" r="4" fill="#C62828"/>
  <text x="140" y="112" font-size="9" fill="#C62828" font-weight="bold">v1</text>
  <circle cx="180" cy="140" r="4" fill="#C62828"/>
  <text x="192" y="140" font-size="9" fill="#C62828" font-weight="bold">v2</text>
  <circle cx="190" cy="180" r="4" fill="#C62828"/>
  <text x="202" y="180" font-size="9" fill="#C62828" font-weight="bold">v3</text>
  <circle cx="170" cy="220" r="4" fill="#C62828"/>
  <text x="182" y="222" font-size="9" fill="#C62828" font-weight="bold">v4</text>
  <circle cx="140" cy="230" r="4" fill="#C62828"/>
  <text x="140" y="248" font-size="9" fill="#C62828" font-weight="bold">v5</text>
  <circle cx="100" cy="220" r="4" fill="#C62828"/>
  <text x="88" y="228" font-size="9" fill="#C62828" font-weight="bold">v6</text>
  <circle cx="80" cy="200" r="4" fill="#C62828"/>
  <text x="65" y="208" font-size="9" fill="#C62828" font-weight="bold">v7</text>
  <circle cx="60" cy="190" r="4" fill="#C62828"/>
  <text x="45" y="195" font-size="9" fill="#C62828" font-weight="bold">v8</text>

  <text x="145" y="270" text-anchor="middle" font-size="9" fill="#333">N vertices: v0, v1, ..., v(N-1)</text>
  <text x="145" y="285" text-anchor="middle" font-size="9" fill="#333">Irregular contour preserved</text>
  <text x="145" y="300" text-anchor="middle" font-size="9" fill="#333">exactly (concavities matter!)</text>

  <!-- Step B: Translate in drift direction -->
  <rect x="290" y="70" width="280" height="250" rx="6" fill="#E8F5E9" stroke="#4CAF50" stroke-width="1.5"/>
  <text x="430" y="92" text-anchor="middle" font-size="13" font-weight="bold" fill="#2E7D32">B. Translate Along Drift</text>

  <!-- Original obstacle (ghost) -->
  <polygon points="330,175 410,155 450,175 460,215 440,255 410,265 370,255 350,235 330,225" fill="#F44336" fill-opacity="0.15" stroke="#C62828" stroke-width="1" stroke-dasharray="4"/>
  <text x="390" y="215" text-anchor="middle" font-size="8" fill="#C62828">Original</text>

  <!-- Translated obstacle (shifted North = up) -->
  <polygon points="330,100 410,80 450,100 460,140 440,180 410,190 370,180 350,160 330,150" fill="#4CAF50" fill-opacity="0.3" stroke="#2E7D32" stroke-width="1.5" stroke-dasharray="4"/>
  <text x="390" y="140" text-anchor="middle" font-size="8" fill="#2E7D32">Translated (far)</text>

  <!-- Drift vector -->
  <line x1="500" y1="250" x2="500" y2="120" stroke="#2E7D32" stroke-width="2" marker-end="url(#arr-s)"/>
  <text x="520" y="185" font-size="9" fill="#2E7D32" font-weight="bold">Drift N</text>
  <text x="520" y="200" font-size="8" fill="#2E7D32">dx, dy from</text>
  <text x="520" y="212" font-size="8" fill="#2E7D32">compass_to_vector()</text>

  <!-- Connecting lines showing vertex correspondence -->
  <line x1="330" y1="175" x2="330" y2="100" stroke="#999" stroke-width="0.5" stroke-dasharray="2"/>
  <line x1="410" y1="155" x2="410" y2="80" stroke="#999" stroke-width="0.5" stroke-dasharray="2"/>
  <line x1="460" y1="215" x2="460" y2="140" stroke="#999" stroke-width="0.5" stroke-dasharray="2"/>

  <text x="430" y="270" text-anchor="middle" font-size="9" fill="#333">dist = 2 x corridor diagonal</text>
  <text x="430" y="285" text-anchor="middle" font-size="9" fill="#333">Ensures shadow extends well</text>
  <text x="430" y="300" text-anchor="middle" font-size="9" fill="#333">beyond corridor boundary</text>

  <!-- Step C: Create Quads -->
  <rect x="590" y="70" width="290" height="250" rx="6" fill="#E3F2FD" stroke="#1976D2" stroke-width="1.5"/>
  <text x="735" y="92" text-anchor="middle" font-size="13" font-weight="bold" fill="#0D47A1">C. Connect Edge Quads</text>

  <!-- Show one quad in detail -->
  <!-- Original edge v0-v1 -->
  <line x1="630" y1="175" x2="700" y2="160" stroke="#C62828" stroke-width="2"/>
  <circle cx="630" cy="175" r="3" fill="#C62828"/>
  <circle cx="700" cy="160" r="3" fill="#C62828"/>
  <text x="620" y="188" font-size="8" fill="#C62828">v_i</text>
  <text x="708" y="155" font-size="8" fill="#C62828">v_i+1</text>

  <!-- Translated edge v0'-v1' -->
  <line x1="630" y1="110" x2="700" y2="95" stroke="#2E7D32" stroke-width="2"/>
  <circle cx="630" cy="110" r="3" fill="#2E7D32"/>
  <circle cx="700" cy="95" r="3" fill="#2E7D32"/>
  <text x="618" y="106" font-size="8" fill="#2E7D32">v'_i</text>
  <text x="708" y="90" font-size="8" fill="#2E7D32">v'_i+1</text>

  <!-- Quad connecting them -->
  <polygon points="630,175 700,160 700,95 630,110" fill="#90CAF9" fill-opacity="0.35" stroke="#1565C0" stroke-width="1.5"/>
  <text x="665" y="140" text-anchor="middle" font-size="9" fill="#0D47A1" font-weight="bold">Quad_i</text>

  <!-- Formula -->
  <text x="735" y="205" text-anchor="middle" font-size="9" fill="#333">For each edge i (0..N-1):</text>
  <text x="735" y="220" text-anchor="middle" font-size="9" fill="#0D47A1" font-weight="bold">Quad_i = Polygon([</text>
  <text x="735" y="235" text-anchor="middle" font-size="9" fill="#0D47A1">  v_i, v_(i+1),</text>
  <text x="735" y="250" text-anchor="middle" font-size="9" fill="#0D47A1">  v'_(i+1), v'_i ])</text>
  <text x="735" y="275" text-anchor="middle" font-size="9" fill="#333">N vertices --> N quads</text>
  <text x="735" y="290" text-anchor="middle" font-size="9" fill="#333">Each quad is a trapezoid</text>
  <text x="735" y="305" text-anchor="middle" font-size="9" fill="#333">connecting corresponding edges</text>

  <!-- ============================================================ -->
  <!-- BOTTOM: Union Result -->
  <!-- ============================================================ -->
  <rect x="20" y="340" width="860" height="340" rx="6" fill="#FCE4EC" stroke="#E91E63" stroke-width="1.5"/>
  <text x="450" y="365" text-anchor="middle" font-size="15" font-weight="bold" fill="#AD1457">D. Final Shadow = union(Original + Quads + Translated)</text>

  <!-- Large illustration showing the full shadow -->
  <g transform="translate(50, 380)">
    <!-- The full shadow shape (union of everything) -->
    <!-- Original obstacle -->
    <polygon points="60,165 140,145 180,165 190,205 170,245 140,255 100,245 80,225 60,215" fill="#F44336" fill-opacity="0.5" stroke="#C62828" stroke-width="2"/>

    <!-- Quads (shown as the connecting region) -->
    <polygon points="60,165 140,145 140,35 60,55" fill="#FFCDD2" fill-opacity="0.3" stroke="#E57373" stroke-width="0.5"/>
    <polygon points="140,145 180,165 180,55 140,35" fill="#FFCDD2" fill-opacity="0.3" stroke="#E57373" stroke-width="0.5"/>
    <polygon points="180,165 190,205 190,95 180,55" fill="#FFCDD2" fill-opacity="0.3" stroke="#E57373" stroke-width="0.5"/>
    <polygon points="190,205 170,245 170,135 190,95" fill="#FFCDD2" fill-opacity="0.3" stroke="#E57373" stroke-width="0.5"/>
    <polygon points="170,245 140,255 140,145 170,135" fill="#FFCDD2" fill-opacity="0.3" stroke="#E57373" stroke-width="0.5"/>
    <polygon points="140,255 100,245 100,135 140,145" fill="#FFCDD2" fill-opacity="0.3" stroke="#E57373" stroke-width="0.5"/>
    <polygon points="100,245 80,225 80,115 100,135" fill="#FFCDD2" fill-opacity="0.3" stroke="#E57373" stroke-width="0.5"/>
    <polygon points="80,225 60,215 60,105 80,115" fill="#FFCDD2" fill-opacity="0.3" stroke="#E57373" stroke-width="0.5"/>
    <polygon points="60,215 60,165 60,55 60,105" fill="#FFCDD2" fill-opacity="0.3" stroke="#E57373" stroke-width="0.5"/>

    <!-- Translated obstacle -->
    <polygon points="60,55 140,35 180,55 190,95 170,135 140,145 100,135 80,115 60,105" fill="#F44336" fill-opacity="0.2" stroke="#C62828" stroke-width="1" stroke-dasharray="4"/>

    <!-- Drift arrow -->
    <line x1="210" y1="240" x2="210" y2="50" stroke="#2E7D32" stroke-width="3" marker-end="url(#arr-s)"/>
    <text x="225" y="145" font-size="11" fill="#2E7D32" font-weight="bold">Drift</text>

    <!-- Labels -->
    <text x="125" y="200" text-anchor="middle" font-size="10" fill="white" font-weight="bold">Obstacle</text>
    <text x="125" y="95" text-anchor="middle" font-size="9" fill="#C62828">Shadow extension</text>
    <text x="125" y="45" text-anchor="middle" font-size="8" fill="#C62828" font-style="italic">Far copy</text>
  </g>

  <!-- Right side: Comparison with convex hull -->
  <g transform="translate(460, 390)">
    <rect x="0" y="0" width="390" height="120" rx="5" fill="white" fill-opacity="0.7" stroke="#AD1457" stroke-width="1"/>
    <text x="195" y="20" text-anchor="middle" font-size="11" font-weight="bold" fill="#AD1457">Why Quad-Sweep, Not Convex Hull?</text>

    <!-- Concave obstacle example -->
    <text x="100" y="42" text-anchor="middle" font-size="9" fill="#333" font-weight="bold">C-shaped obstacle:</text>

    <!-- Obstacle shape (C-shape) -->
    <polygon points="30,50 80,50 80,65 50,65 50,85 80,85 80,100 30,100" fill="#F44336" fill-opacity="0.5" stroke="#C62828" stroke-width="1.5"/>
    <text x="55" y="78" text-anchor="middle" font-size="7" fill="white" font-weight="bold">gap</text>

    <!-- Convex hull shadow (wrong - fills gap) -->
    <rect x="120" y="45" width="100" height="70" fill="#FFCDD2" fill-opacity="0.4" stroke="#C62828" stroke-width="1" stroke-dasharray="3"/>
    <polygon points="120,50 170,50 170,100 120,100" fill="#F44336" fill-opacity="0.3"/>
    <text x="170" y="78" text-anchor="middle" font-size="8" fill="#C62828">Convex hull</text>
    <text x="170" y="90" text-anchor="middle" font-size="7" fill="#C62828">gap FILLED</text>

    <!-- Quad-sweep shadow (correct - preserves gap) -->
    <g transform="translate(230,0)">
      <polygon points="30,50 80,50 80,65 50,65 50,85 80,85 80,100 30,100" fill="#C8E6C9" fill-opacity="0.4" stroke="#2E7D32" stroke-width="1"/>
      <rect x="30" y="45" width="50" height="60" fill="#C8E6C9" fill-opacity="0.2"/>
      <rect x="50" y="65" width="10" height="20" fill="white"/>
      <text x="80" y="78" text-anchor="middle" font-size="8" fill="#2E7D32">Quad-sweep</text>
      <text x="80" y="90" text-anchor="middle" font-size="7" fill="#2E7D32">gap PRESERVED</text>
    </g>
  </g>

  <!-- Key properties -->
  <g transform="translate(460, 530)">
    <rect x="0" y="0" width="390" height="130" rx="5" fill="white" fill-opacity="0.7" stroke="#78909C" stroke-width="1"/>
    <text x="195" y="20" text-anchor="middle" font-size="11" font-weight="bold" fill="#37474F">Shadow Properties</text>
    <text x="15" y="42" font-size="9" fill="#333">1. Shadow contains the original obstacle</text>
    <text x="15" y="58" font-size="9" fill="#333">2. Extends only in the drift direction</text>
    <text x="15" y="74" font-size="9" fill="#333">3. Preserves concave features exactly</text>
    <text x="15" y="90" font-size="9" fill="#333">4. Ships in shadow zone are "blocked" by obstacle</text>
    <text x="15" y="106" font-size="9" fill="#333">5. Multiple shadows are unioned before subtracting</text>
    <text x="15" y="122" font-size="9" fill="#666">Implementation: geometries/drift/shadow.py</text>
  </g>
</svg>
