<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Code Architecture &#8212; OMRAT 0.3.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=ff28a369" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=b5312e80" />
    <script src="_static/documentation_options.js?v=4621528c"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API Reference" href="api.html" />
    <link rel="prev" title="Powered Grounding and Allision" href="powered.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">OMRAT</a></h1>



<p class="blurb">Open Maritime Risk Analysis Tool - QGIS Plugin</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=axelande&repo=OMRAT&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>






<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Project Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="user_guide.html">User Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Theory &amp; Calculations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="theory.html">Mathematical Foundations</a></li>
<li class="toctree-l1"><a class="reference internal" href="drifting.html">Drifting Risk Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="collisions.html">Ship-Ship Collision Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="powered.html">Powered Grounding and Allision</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Guide</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Code Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#directory-structure">Directory Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-flow">Data Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="#key-classes">Key Classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-structures">Data Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="#background-task-execution">Background Task Execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="#iwrap-integration">IWRAP Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#project-persistence">Project Persistence</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="powered.html" title="previous chapter">Powered Grounding and Allision</a></li>
      <li>Next: <a href="api.html" title="next chapter">API Reference</a></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="code-architecture">
<span id="architecture"></span><h1>Code Architecture<a class="headerlink" href="#code-architecture" title="Link to this heading">¶</a></h1>
<p>This chapter describes the internal architecture of OMRAT, including
the module structure, class hierarchy, and data flow between components.</p>
<nav class="contents local" id="in-this-chapter">
<p class="topic-title">In this chapter</p>
<ul class="simple">
<li><p><a class="reference internal" href="#directory-structure" id="id1">Directory Structure</a></p></li>
<li><p><a class="reference internal" href="#data-flow" id="id2">Data Flow</a></p></li>
<li><p><a class="reference internal" href="#key-classes" id="id3">Key Classes</a></p>
<ul>
<li><p><a class="reference internal" href="#omrat-omrat-py" id="id4">OMRAT (omrat.py)</a></p></li>
<li><p><a class="reference internal" href="#omratmainwidget-omrat-widget-py" id="id5">OMRATMainWidget (omrat_widget.py)</a></p></li>
<li><p><a class="reference internal" href="#calculation-compute-run-calculations-py" id="id6">Calculation (compute/run_calculations.py)</a></p></li>
<li><p><a class="reference internal" href="#driftcorridorgenerator-geometries-drift-generator-py" id="id7">DriftCorridorGenerator (geometries/drift/generator.py)</a></p></li>
<li><p><a class="reference internal" href="#handleqgisiface-geometries-handle-qgis-iface-py" id="id8">HandleQGISIface (geometries/handle_qgis_iface.py)</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#data-structures" id="id9">Data Structures</a></p>
<ul>
<li><p><a class="reference internal" href="#traffic-data" id="id10">Traffic Data</a></p></li>
<li><p><a class="reference internal" href="#segment-data" id="id11">Segment Data</a></p></li>
<li><p><a class="reference internal" href="#drift-values" id="id12">Drift Values</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#background-task-execution" id="id13">Background Task Execution</a></p>
<ul>
<li><p><a class="reference internal" href="#calculationtask" id="id14">CalculationTask</a></p></li>
<li><p><a class="reference internal" href="#driftcorridortask" id="id15">DriftCorridorTask</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#iwrap-integration" id="id16">IWRAP Integration</a></p></li>
<li><p><a class="reference internal" href="#project-persistence" id="id17">Project Persistence</a></p></li>
</ul>
</nav>
<section id="directory-structure">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Directory Structure</a><a class="headerlink" href="#directory-structure" title="Link to this heading">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>OMRAT/
├── omrat.py                    # Main plugin class (entry point)
├── omrat_widget.py             # Main UI dock widget
├── __init__.py                 # Plugin initialisation (classFactory)
│
├── compute/                    # Risk calculation engine
│   ├── basic_equations.py      # Core mathematical formulas
│   ├── run_calculations.py     # Calculation orchestration
│   ├── calculation_task.py     # QgsTask wrapper for background exec
│   ├── database.py             # PostgreSQL/PostGIS connector
│   └── iwrap_convertion.py     # IWRAP XML import/export
│
├── geometries/                 # Spatial geometry operations
│   ├── handle_qgis_iface.py    # Route digitisation &amp; layer mgmt
│   ├── route.py                # Route processing utilities
│   ├── drift_corridor_v2.py    # Drift corridor API (re-exports)
│   ├── drift_corridor_task_v2.py  # Background corridor generation
│   ├── get_drifting_overlap.py # Overlap visualisation
│   ├── calculate_probability_holes.py  # Monte Carlo integration
│   ├── result_layers.py        # Result QGIS layer creation
│   └── drift/                  # Refactored drift submodule
│       ├── constants.py        # Direction constants (N,NE,E,...)
│       ├── coordinates.py      # CRS transformations
│       ├── distribution.py     # Width &amp; projection distance
│       ├── corridor.py         # Base surface &amp; projected corridor
│       ├── shadow.py           # Obstacle blocking zones
│       ├── clipping.py         # Corridor clipping &amp; anchor split
│       ├── generator.py        # Main corridor generator (~800 lines)
│       └── probability_integration.py  # Probability hole integration
│
├── omrat_utils/                # Data management utilities
│   ├── handle_traffic.py       # Traffic table management
│   ├── handle_object.py        # Depth &amp; structure management
│   ├── handle_ais.py           # AIS database integration
│   ├── handle_distributions.py # Lateral distribution modelling
│   ├── handle_settings.py      # Drift parameter configuration
│   ├── handle_ship_cat.py      # Ship type classifications
│   ├── causation_factors.py    # Causation factor management
│   ├── gather_data.py          # Data serialisation/deserialisation
│   ├── storage.py              # Project file I/O (.omrat JSON)
│   ├── validate_data.py        # Pydantic validation schemas
│   ├── repair_time.py          # Repair time distribution
│   └── units.py                # Unit conversion utilities
│
├── ui/                         # User interface widgets
│   ├── drift_settings_widget.py
│   ├── traffic_data_widget.py
│   ├── ship_categories_widget.py
│   ├── ais_connection_widget.py
│   ├── causation_factor_widget.py
│   ├── result_widget.py
│   └── show_geom_res.py
│
├── helpers/                    # Helper utilities
│   └── qt_conversions.py       # Qt5/Qt6 compatibility
│
├── tests/                      # Test suite
└── help/                       # Documentation (Sphinx)
</pre></div>
</div>
</section>
<section id="data-flow">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Data Flow</a><a class="headerlink" href="#data-flow" title="Link to this heading">¶</a></h2>
<p>The following diagram shows how data flows through OMRAT from input to
output:</p>
<a class="reference internal image-reference" href="_images/data_flow.svg"><img alt="Data flow from inputs through calculations to outputs" src="_images/data_flow.svg" style="width: 100%;" />
</a>
<p>The data flow can be summarised in five phases:</p>
<ol class="arabic simple">
<li><p><strong>Input</strong>: Routes are digitised on the map, traffic data is entered
or imported from AIS, obstacles are loaded from shapefiles or GEBCO.</p></li>
<li><p><strong>Collection</strong>: <code class="docutils literal notranslate"><span class="pre">gather_data.py</span></code> aggregates all data into a
single dictionary for calculation and persistence.</p></li>
<li><p><strong>Transformation</strong>: Geometries are transformed from WGS84 to UTM for
accurate distance-based calculations.</p></li>
<li><p><strong>Calculation</strong>: Three parallel pipelines compute drifting risk,
powered risk, and collision risk.</p></li>
<li><p><strong>Output</strong>: Results are visualised as QGIS layers and stored in the
project file.</p></li>
</ol>
</section>
<section id="key-classes">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Key Classes</a><a class="headerlink" href="#key-classes" title="Link to this heading">¶</a></h2>
<section id="omrat-omrat-py">
<h3><a class="toc-backref" href="#id4" role="doc-backlink">OMRAT (omrat.py)</a><a class="headerlink" href="#omrat-omrat-py" title="Link to this heading">¶</a></h3>
<p>The main plugin class. It owns all other components and orchestrates
the plugin lifecycle:</p>
<ul class="simple">
<li><p><strong>Initialisation</strong>: Creates instances of all manager classes (Traffic,
OObject, DriftSettings, etc.)</p></li>
<li><p><strong>Signal management</strong>: Connects UI buttons to handler methods</p></li>
<li><p><strong>Calculation dispatch</strong>: Creates <code class="docutils literal notranslate"><span class="pre">CalculationTask</span></code> or
<code class="docutils literal notranslate"><span class="pre">DriftCorridorTask</span></code> instances for background execution</p></li>
<li><p><strong>Menu/toolbar</strong>: Registers QGIS menu items and toolbar buttons</p></li>
</ul>
<div class="source-code-ref docutils container">
<p><code class="docutils literal notranslate"><span class="pre">omrat.py</span></code> – <a class="reference external" href="https://github.com/axelande/OMRAT/blob/main/omrat.py">OMRAT</a> (main plugin entry point)</p>
</div>
</section>
<section id="omratmainwidget-omrat-widget-py">
<h3><a class="toc-backref" href="#id5" role="doc-backlink">OMRATMainWidget (omrat_widget.py)</a><a class="headerlink" href="#omratmainwidget-omrat-widget-py" title="Link to this heading">¶</a></h3>
<p>The Qt dock widget that provides the user interface. It is built from
<code class="docutils literal notranslate"><span class="pre">omrat_base.ui</span></code> (Qt Designer file) and contains:</p>
<ul class="simple">
<li><p><strong>Route tab</strong>: Route table, digitisation buttons</p></li>
<li><p><strong>Traffic tab</strong>: Ship frequency/speed/dimension tables</p></li>
<li><p><strong>Depths tab</strong>: Depth polygon management, GEBCO download</p></li>
<li><p><strong>Objects tab</strong>: Structure polygon management</p></li>
<li><p><strong>Distributions tab</strong>: Lateral distribution configuration and plots</p></li>
<li><p><strong>Results tab</strong>: Calculation results display</p></li>
<li><p><strong>Drift Analysis tab</strong>: Corridor generation controls</p></li>
</ul>
</section>
<section id="calculation-compute-run-calculations-py">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">Calculation (compute/run_calculations.py)</a><a class="headerlink" href="#calculation-compute-run-calculations-py" title="Link to this heading">¶</a></h3>
<p>The main calculation engine. Key responsibilities:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">run_drifting_model(data)</span></code>: Computes drifting grounding/allision
probabilities using Monte Carlo integration</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_ship_collision_model(data)</span></code>: Computes ship-ship collision
frequencies</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_powered_grounding_model(data)</span></code>: Computes powered grounding
(Category I and II)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_powered_allision_model(data)</span></code>: Computes powered allision</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_drift_visualization(data)</span></code>: Creates visual corridor layers</p></li>
</ul>
<div class="source-code-ref docutils container">
<p><code class="docutils literal notranslate"><span class="pre">compute/run_calculations.py:44</span></code> – <a class="reference external" href="https://github.com/axelande/OMRAT/blob/main/compute/run_calculations.py#L44">Calculation</a> (mixin-based facade) |
Mixins: <a class="reference external" href="https://github.com/axelande/OMRAT/blob/main/compute/drifting_model.py">DriftingModelMixin</a>,
<a class="reference external" href="https://github.com/axelande/OMRAT/blob/main/compute/ship_collision_model.py">ShipCollisionModelMixin</a>,
<a class="reference external" href="https://github.com/axelande/OMRAT/blob/main/compute/powered_model.py">PoweredModelMixin</a>,
<a class="reference external" href="https://github.com/axelande/OMRAT/blob/main/compute/drifting_report.py">DriftingReportMixin</a>,
<a class="reference external" href="https://github.com/axelande/OMRAT/blob/main/compute/visualization.py">VisualizationMixin</a></p>
</div>
</section>
<section id="driftcorridorgenerator-geometries-drift-generator-py">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">DriftCorridorGenerator (geometries/drift/generator.py)</a><a class="headerlink" href="#driftcorridorgenerator-geometries-drift-generator-py" title="Link to this heading">¶</a></h3>
<p>Orchestrates drift corridor generation for all legs and directions:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">precollect_data()</span></code>: Gathers UI data in the main thread (required
because Qt widgets are thread-unsafe)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">generate_corridors()</span></code>: Generates corridors in a background thread</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_create_single_corridor()</span></code>: Creates one corridor for one leg in
one direction</p></li>
</ul>
<div class="source-code-ref docutils container">
<p><code class="docutils literal notranslate"><span class="pre">geometries/drift/generator.py:25</span></code> – <a class="reference external" href="https://github.com/axelande/OMRAT/blob/main/geometries/drift/generator.py#L25">DriftCorridorGenerator</a> |
<code class="docutils literal notranslate"><span class="pre">geometries/drift/generator.py:65</span></code> – <a class="reference external" href="https://github.com/axelande/OMRAT/blob/main/geometries/drift/generator.py#L65">precollect_data()</a> |
<code class="docutils literal notranslate"><span class="pre">geometries/drift/generator.py:360</span></code> – <a class="reference external" href="https://github.com/axelande/OMRAT/blob/main/geometries/drift/generator.py#L360">generate_corridors()</a> |
<code class="docutils literal notranslate"><span class="pre">geometries/drift/generator.py:516</span></code> – <a class="reference external" href="https://github.com/axelande/OMRAT/blob/main/geometries/drift/generator.py#L516">_create_single_corridor()</a></p>
</div>
</section>
<section id="handleqgisiface-geometries-handle-qgis-iface-py">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">HandleQGISIface (geometries/handle_qgis_iface.py)</a><a class="headerlink" href="#handleqgisiface-geometries-handle-qgis-iface-py" title="Link to this heading">¶</a></h3>
<p>Manages QGIS layer operations for route digitisation:</p>
<ul class="simple">
<li><p>Route creation via map click tool</p></li>
<li><p>Segment data tracking (start/end points, directions, widths)</p></li>
<li><p>Visual offset lines showing route width</p></li>
<li><p>Geometry change detection for interactive editing</p></li>
</ul>
<div class="source-code-ref docutils container">
<p><code class="docutils literal notranslate"><span class="pre">geometries/handle_qgis_iface.py</span></code> – <a class="reference external" href="https://github.com/axelande/OMRAT/blob/main/geometries/handle_qgis_iface.py">HandleQGISIface</a></p>
</div>
</section>
</section>
<section id="data-structures">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Data Structures</a><a class="headerlink" href="#data-structures" title="Link to this heading">¶</a></h2>
<section id="traffic-data">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">Traffic Data</a><a class="headerlink" href="#traffic-data" title="Link to this heading">¶</a></h3>
<p>Traffic data is stored in a nested dictionary:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">traffic_data</span><span class="p">[</span><span class="n">segment_id</span><span class="p">][</span><span class="n">direction</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Frequency (ships/year)&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">...</span><span class="p">],</span>   <span class="c1"># [type][size]</span>
    <span class="s1">&#39;Speed (knots)&#39;</span><span class="p">:</span>          <span class="p">[[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">...</span><span class="p">],</span>
    <span class="s1">&#39;Draught (meters)&#39;</span><span class="p">:</span>       <span class="p">[[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">...</span><span class="p">],</span>
    <span class="s1">&#39;Ship heights (meters)&#39;</span><span class="p">:</span>  <span class="p">[[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">...</span><span class="p">],</span>
    <span class="s1">&#39;Ship Beam (meters)&#39;</span><span class="p">:</span>     <span class="p">[[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">...</span><span class="p">],</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Each value is a 2D array indexed by <code class="docutils literal notranslate"><span class="pre">[ship_type_index][ship_size_index]</span></code>.</p>
</section>
<section id="segment-data">
<h3><a class="toc-backref" href="#id11" role="doc-backlink">Segment Data</a><a class="headerlink" href="#segment-data" title="Link to this heading">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">segment_data</span><span class="p">[</span><span class="n">segment_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Start_Point&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>      <span class="c1"># WKT point</span>
    <span class="s1">&#39;End_Point&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>        <span class="c1"># WKT point</span>
    <span class="s1">&#39;Dirs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>      <span class="c1"># Direction labels</span>
    <span class="s1">&#39;Width&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>          <span class="c1"># Lane width (m)</span>
    <span class="s1">&#39;line_length&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>    <span class="c1"># Segment length (m)</span>
    <span class="s1">&#39;Route_Id&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="s1">&#39;Leg_name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;Segment_Id&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="c1"># Distribution parameters:</span>
    <span class="s1">&#39;mean1_1&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;std1_1&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;weight1_1&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s1">&#39;mean1_2&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;std1_2&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;weight1_2&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s1">&#39;mean1_3&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;std1_3&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;weight1_3&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s1">&#39;u_min1&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;u_max1&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;u_p1&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="c1"># ... same for direction 2 ...</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="drift-values">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">Drift Values</a><a class="headerlink" href="#drift-values" title="Link to this heading">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">drift_values</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;drift_p&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>           <span class="c1"># Blackout frequency</span>
    <span class="s1">&#39;anchor_p&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>          <span class="c1"># Anchor probability</span>
    <span class="s1">&#39;anchor_d&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>          <span class="c1"># Max anchorable depth (m)</span>
    <span class="s1">&#39;speed&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>             <span class="c1"># Drift speed (m/s)</span>
    <span class="s1">&#39;rose&#39;</span><span class="p">:</span> <span class="p">{</span>                   <span class="c1"># Wind rose probabilities</span>
        <span class="s1">&#39;0&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>             <span class="c1"># North</span>
        <span class="s1">&#39;45&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>            <span class="c1"># NorthWest</span>
        <span class="s1">&#39;90&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>            <span class="c1"># West</span>
        <span class="s1">&#39;135&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>           <span class="c1"># SouthWest</span>
        <span class="s1">&#39;180&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>           <span class="c1"># South</span>
        <span class="s1">&#39;225&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>           <span class="c1"># SouthEast</span>
        <span class="s1">&#39;270&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>           <span class="c1"># East</span>
        <span class="s1">&#39;315&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>           <span class="c1"># NorthEast</span>
    <span class="p">},</span>
    <span class="s1">&#39;repair&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>            <span class="c1"># Custom function expression</span>
        <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>           <span class="c1"># Lognormal shape</span>
        <span class="s1">&#39;loc&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>           <span class="c1"># Location parameter</span>
        <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>         <span class="c1"># Scale parameter</span>
        <span class="s1">&#39;use_lognormal&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>  <span class="c1"># Use lognormal or custom</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="background-task-execution">
<h2><a class="toc-backref" href="#id13" role="doc-backlink">Background Task Execution</a><a class="headerlink" href="#background-task-execution" title="Link to this heading">¶</a></h2>
<p>OMRAT uses QGIS’s <code class="docutils literal notranslate"><span class="pre">QgsTask</span></code> system for long-running calculations.
This keeps the UI responsive while computations run in background
threads.</p>
<section id="calculationtask">
<h3><a class="toc-backref" href="#id14" role="doc-backlink">CalculationTask</a><a class="headerlink" href="#calculationtask" title="Link to this heading">¶</a></h3>
<p>Wraps the full risk calculation pipeline:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">run_drifting_model()</span></code> – probability holes (60% of time)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_ship_collision_model()</span></code> – collision frequencies (fast)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_powered_grounding_model()</span></code> – powered grounding</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_powered_allision_model()</span></code> – powered allision</p></li>
</ol>
<p>Signals emitted: <code class="docutils literal notranslate"><span class="pre">progress_updated</span></code>, <code class="docutils literal notranslate"><span class="pre">calculation_finished</span></code>,
<code class="docutils literal notranslate"><span class="pre">calculation_failed</span></code>.</p>
<div class="source-code-ref docutils container">
<p><code class="docutils literal notranslate"><span class="pre">compute/calculation_task.py</span></code> – <a class="reference external" href="https://github.com/axelande/OMRAT/blob/main/compute/calculation_task.py">CalculationTask</a></p>
</div>
</section>
<section id="driftcorridortask">
<h3><a class="toc-backref" href="#id15" role="doc-backlink">DriftCorridorTask</a><a class="headerlink" href="#driftcorridortask" title="Link to this heading">¶</a></h3>
<p>Wraps the drift corridor generation:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">precollect_data()</span></code> runs in the main thread (before task starts)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">generate_corridors()</span></code> runs in the background thread</p></li>
<li><p>Layer creation runs in the main thread (via <code class="docutils literal notranslate"><span class="pre">finished()</span></code> signal)</p></li>
</ol>
<p>Signals emitted: <code class="docutils literal notranslate"><span class="pre">progress_updated</span></code>, <code class="docutils literal notranslate"><span class="pre">corridors_generated</span></code>,
<code class="docutils literal notranslate"><span class="pre">generation_failed</span></code>.</p>
<div class="source-code-ref docutils container">
<p><code class="docutils literal notranslate"><span class="pre">geometries/drift_corridor_task_v2.py</span></code> – <a class="reference external" href="https://github.com/axelande/OMRAT/blob/main/geometries/drift_corridor_task_v2.py">DriftCorridorTask</a></p>
</div>
</section>
</section>
<section id="iwrap-integration">
<h2><a class="toc-backref" href="#id16" role="doc-backlink">IWRAP Integration</a><a class="headerlink" href="#iwrap-integration" title="Link to this heading">¶</a></h2>
<p>OMRAT supports bidirectional conversion with IWRAP XML format:</p>
<p><strong>Export</strong> (<code class="docutils literal notranslate"><span class="pre">write_iwrap_xml</span></code>):</p>
<ol class="arabic simple">
<li><p>Gather project data via <code class="docutils literal notranslate"><span class="pre">GatherData</span></code></p></li>
<li><p>Build XML tree with waypoints, legs, traffic distributions, obstacles</p></li>
<li><p>Write formatted XML file</p></li>
</ol>
<p><strong>Import</strong> (<code class="docutils literal notranslate"><span class="pre">parse_iwrap_xml</span></code>):</p>
<ol class="arabic simple">
<li><p>Parse XML tree structure</p></li>
<li><p>Extract waypoints, legs, traffic, causation factors</p></li>
<li><p>Map to OMRAT’s internal data format</p></li>
<li><p>Validate with Pydantic schema</p></li>
<li><p>Populate UI via <code class="docutils literal notranslate"><span class="pre">GatherData.populate()</span></code></p></li>
</ol>
<p>The conversion handles differences in data model between IWRAP and OMRAT,
including coordinate format, traffic representation, and distribution
parameters.</p>
<div class="source-code-ref docutils container">
<p><code class="docutils literal notranslate"><span class="pre">compute/iwrap_convertion.py</span></code> – <a class="reference external" href="https://github.com/axelande/OMRAT/blob/main/compute/iwrap_convertion.py">IWRAP conversion module</a></p>
</div>
</section>
<section id="project-persistence">
<h2><a class="toc-backref" href="#id17" role="doc-backlink">Project Persistence</a><a class="headerlink" href="#project-persistence" title="Link to this heading">¶</a></h2>
<p>Projects are saved as <code class="docutils literal notranslate"><span class="pre">.omrat</span></code> files (JSON format):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;project_name&quot;</span><span class="p">:</span> <span class="s2">&quot;My Analysis&quot;</span><span class="p">,</span>
  <span class="s2">&quot;pc&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;p_pc&quot;</span><span class="p">:</span> <span class="mf">1.6e-4</span><span class="p">,</span> <span class="s2">&quot;d_pc&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">},</span>
  <span class="s2">&quot;drift&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;drift_p&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;anchor_p&quot;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span> <span class="s2">&quot;anchor_d&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
    <span class="s2">&quot;speed&quot;</span><span class="p">:</span> <span class="mf">1.944</span><span class="p">,</span> <span class="s2">&quot;rose&quot;</span><span class="p">:</span> <span class="p">{</span><span class="o">...</span><span class="p">},</span> <span class="s2">&quot;repair&quot;</span><span class="p">:</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">&quot;traffic_data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="o">...</span><span class="p">},</span>
  <span class="s2">&quot;segment_data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="o">...</span><span class="p">},</span>
  <span class="s2">&quot;depths&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="nb">id</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">wkt</span><span class="p">],</span> <span class="o">...</span><span class="p">],</span>
  <span class="s2">&quot;objects&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="nb">id</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">wkt</span><span class="p">],</span> <span class="o">...</span><span class="p">],</span>
  <span class="s2">&quot;ship_categories&quot;</span><span class="p">:</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">validate_data.py</span></code> module defines a Pydantic schema
(<code class="docutils literal notranslate"><span class="pre">RootModelSchema</span></code>) that validates the structure on save and load.
Legacy format conversion is handled by <code class="docutils literal notranslate"><span class="pre">Storage._normalize_legacy_to_schema()</span></code>.</p>
<div class="source-code-ref docutils container">
<p><code class="docutils literal notranslate"><span class="pre">omrat_utils/storage.py</span></code> – <a class="reference external" href="https://github.com/axelande/OMRAT/blob/main/omrat_utils/storage.py">Storage</a> |
<code class="docutils literal notranslate"><span class="pre">omrat_utils/validate_data.py</span></code> – <a class="reference external" href="https://github.com/axelande/OMRAT/blob/main/omrat_utils/validate_data.py">Validation schemas</a></p>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;2022-2026, Axel Hörteborn / RISE.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/architecture.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>